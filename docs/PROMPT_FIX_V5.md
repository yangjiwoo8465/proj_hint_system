# 프롬프트 수정 V5 - 모든 예시 완전 제거

## 문제 상황 (V4 → V5)

### 체스판 문제에서 발생한 문제

**사용자 코드:**
```python
N, M = map(int, input().split())
board = []
for _ in range(N):
    board.append(input())
```

**생성된 힌트 (V4):**
```
📌 Qwen2.5-Coder-1.5B
"이상한 코드를 100번 쓰려고 하는데 어떤 대안을 고민하나요"
```

**문제 원인:**
- 프롬프트의 "질문 방식" 섹션에 예시 제공:
  - "지금 코드를 100번 복사해야 한다면 어떻게 할까?"
  - "이 작업을 나중에 다시 써야 한다면?"
- 모델이 이 예시를 참조해서 비슷한 표현 생성
- 결과: **"이상한 코드를 100번 쓰려고..."** (예시의 변형)

---

## 핵심 수정 사항

### V4 프롬프트 (Before)

```python
질문 원칙:
1. 구체적 이름(함수명, 변수명) 절대 금지
2. 학생의 상황에서 시작하기 (예: "같은 코드를 10번 써야 한다면?")
3. 문제 상황을 제시하고 해결 방법을 스스로 생각하게 만들기

질문 방식:
- "지금 코드를 100번 복사해야 한다면 어떻게 할까?"
- "이 작업을 나중에 다시 써야 한다면?"
- "값이 1000개라면 일일이 비교할 건가?"

한국어 반말로 한 문장:
```

**문제:**
- "질문 방식" 섹션의 구체적 예시를 모델이 그대로 따라함
- 예시가 있으면 모델이 창의적으로 생각하지 않고 복사함

---

### V5 프롬프트 (After)

```python
당신의 임무:
학생이 "{next_step_goal}"를 스스로 깨닫도록 유도하는 짧은 질문 1개를 만드세요.

소크라테스식 질문 원칙:
1. 절대 금지: 함수명, 변수명, 코드 구조 언급
2. 학생 코드의 한계점을 확장된 상황으로 제시
3. "만약 ~라면?" 형식으로 문제 상황 가정
4. 학생이 불편함을 느끼고 해결책을 생각하게 만들기

질문 생성 방법:
- 현재 코드가 감당하기 어려운 상황 제시
- 규모가 커지면 어떻게 되는지 질문
- 반복/수정이 필요한 상황 강조

출력: 한국어 반말로 질문 1개만 (설명 없이):
```

**개선 사항:**
1. **모든 구체적 예시 제거** - "100번 복사", "1000개" 같은 숫자 예시 삭제
2. **추상적 원칙으로 대체** - "규모가 커지면", "반복/수정이 필요한 상황"
3. **방법론 제시** - 어떻게 질문을 만들지 설명 (예시 없이)
4. **출력 형식 강조** - "질문 1개만 (설명 없이)"

---

## 변경 이유

### 예시 제공의 문제점

1. **모델이 예시를 복사함**
   - 창의적 사고 차단
   - 비슷한 표현 반복

2. **컨텍스트 무시**
   - 사용자 코드와 무관한 예시 그대로 사용
   - "100번", "1000개" 같은 숫자가 모든 상황에 적합하지 않음

3. **일반화 실패**
   - 예시에 의존해서 다른 상황에 적응 못함

### 원칙 제시의 장점

1. **모델이 스스로 판단**
   - 사용자 코드에 맞는 질문 생성
   - 다양한 상황에 유연하게 대응

2. **추상적 사고 유도**
   - "규모가 커지면?" → 모델이 직접 구체화
   - 다양한 표현 가능

3. **과적합 방지**
   - 특정 예시에 의존하지 않음
   - 일반화된 질문 생성

---

## 기대 효과

### V4 힌트 (예시 의존)
```
"이상한 코드를 100번 쓰려고 하는데 어떤 대안을 고민하나요"
```
→ 프롬프트 예시 "100번"을 그대로 사용

### V5 힌트 (예상)
```
"체스판 크기가 더 커지면 모든 경우를 어떻게 확인할 건가?"
"같은 작업을 여러 위치에서 반복해야 한다면?"
"8x8 검사를 다른 곳에서도 써야 한다면?"
```
→ 사용자 코드와 문제 맥락에 맞는 자연스러운 질문

---

## 변경 위치

### 1. 프롬프트 개선 ([app.py:322-348](../hint-system/app.py#L322-L348))

**파일:** `hint-system/app.py`
**함수:** `_create_analysis_prompt()`
**변경사항:**
- 모든 구체적 예시 제거
- 절대 금지 사항 명시 (함수명, 변수명, 백틱 사용 금지)
- 출력 형식 강조

### 2. 필터링 개선 ([model_inference.py:174-266](../hint-system/models/model_inference.py#L174-L266))

**파일:** `hint-system/models/model_inference.py`
**함수:** `_extract_hint_from_output()`
**변경사항:**
- 한국어 비율 체크 시 백틱/코드 블록 제외 (174-185줄)
- 백틱 함수명 필터 추가 (253-255줄)

---

## 추가 문제 해결: 한국어 필터 오탐

### 문제 상황 (추가 발견)

터미널 출력:
```
[DEBUG] 원본 출력: **답변:** 만약 `print_board`라는 함수가...
[DEBUG] 영어 출력 필터링: **답변:** 만약 `print_...
```

화면 표시:
```
📌 Qwen2.5-Coder-1.5B
(모델이 한국어 힌트를 생성하지 못했습니다)
```

**원인:**
- 모델이 백틱으로 함수명 언급: `` `print_board` ``
- 한국어 비율 체크 시 백틱도 포함되어 한국어 비율 30% 미만
- 정상적인 한국어 힌트가 "영어 출력"으로 오판

### 해결책 (model_inference.py:174-185)

**Before:**
```python
korean_chars = len(re.findall(r'[가-힣]', clean))
total_chars = len(clean.replace(' ', ''))
```
→ 백틱과 코드도 글자 수에 포함

**After:**
```python
text_without_code = re.sub(r'`[^`]+`', '', clean)  # 인라인 코드 제거
text_without_code = re.sub(r'```[^`]+```', '', text_without_code)  # 코드 블록 제거

korean_chars = len(re.findall(r'[가-힣]', text_without_code))
total_chars = len(text_without_code.replace(' ', ''))
```
→ 코드 부분 제외하고 순수 텍스트만 체크

### 백틱 함수명 필터 추가 (model_inference.py:253-255)

```python
# 백틱으로 감싸진 함수명/변수명 차단
if re.search(r'`[a-z_]+`', sentence):
    print(f"[DEBUG] 백틱 함수명 언급 필터링: {sentence[:50]}...")
    continue
```

---

---

## 추가 문제 해결 2: 불완전한 문장

### 문제 상황

**생성된 힌트:**
```
입력 받는 두 수 N, M에서 각 행마다 특정 문자열 확인하고,
```

**문제:**
- 문장이 쉼표(,)로 끝남 → 불완전한 문장
- 물음표(?)가 없어서 질문 아님
- 모델이 생성을 중간에 멈춤

### 해결책 1: 불완전한 문장 필터 추가 (model_inference.py:295-299)

```python
# 불완전한 문장 필터링
incomplete_endings = [',', '그리고', '그런데', '또는', '및', '와', '과', '~고', '~며']
if any(sentence.endswith(ending) for ending in incomplete_endings):
    print(f"[DEBUG] 불완전한 문장 필터링: {sentence[:50]}...")
    continue
```

### 해결책 2: 프롬프트에 출력 형식 강화 (app.py:346-352)

**Before:**
```python
출력 형식:
한국어 반말로 질문 1개만. 코드나 구체적 이름 없이 순수 질문만:
```

**After:**
```python
출력 형식:
- 한국어 반말로 완전한 질문 1개만
- 반드시 물음표(?)로 끝나야 함
- 불완전한 문장 금지 (예: "~하고,", "~하며," 같은 끝맺음)
- 코드나 구체적 이름 없이 순수 질문만

질문:
```

**효과:**
- 모델에게 "반드시 물음표로 끝내라" 명시
- 불완전한 끝맺음 예시 제공
- 필터가 자동으로 불완전한 문장 제거

---

## 테스트 필요

### 테스트 케이스

1. **체스판 문제 (#1018)**
   - 입력만 받은 코드 → 함수 정의 힌트
   - 기대: 구체적 예시 없이 자연스러운 질문

2. **A+B 문제 (#1000)**
   - 아무것도 없는 코드 → 입력 받기 힌트
   - 기대: "값을 어떻게 가져올까?" 같은 추상적 질문

3. **반복문 필요 문제**
   - 하드코딩된 코드 → 반복문 힌트
   - 기대: "개수가 바뀌면?" 같은 확장 상황 질문

---

## V1 → V5 변천사

| 버전 | 주요 변경 | 문제점 |
|------|-----------|--------|
| **V1** | 기본 프롬프트 | 함수명/변수명 언급 |
| **V2** | solution_code 제거, 나쁜 예시 추가 | 나쁜 예시를 따라함 |
| **V3** | 나쁜 예시 제거, snake_case 필터 추가 | 여전히 예시 의존 |
| **V4** | 진짜 소크라테스식 질문 방식 도입 | "질문 방식" 예시를 따라함 |
| **V5** | 모든 구체적 예시 제거, 추상적 원칙만 제시 | ✅ 해결 예상 |

---

## 결론

**핵심 원칙:** 모델에게 예시를 주지 말고, **어떻게 생각해야 하는지 원칙만** 알려주자.

- ❌ "100번 복사해야 한다면?" (구체적 예시)
- ✅ "규모가 커지면 어떻게 되는지 질문" (추상적 원칙)

모델이 사용자 코드를 직접 분석해서 맥락에 맞는 질문을 생성하도록 유도.

---

**작성일:** 2025-01-30
**버전:** V5
**이전 버전:** [PROMPT_FIX_V3.md](PROMPT_FIX_V3.md)
