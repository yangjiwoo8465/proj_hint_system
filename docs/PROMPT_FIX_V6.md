# 프롬프트 수정 V6 - 초간단 직접 명령

## 문제 상황 (V5 → V6)

### 모델이 혼란스러워함

**터미널 출력:**
```
[DEBUG] 원본 출력: 그런데... 어떻게~? I'm really confused about how to define functions here.
[DEBUG] 영어 출력 필터링: 그런데... 어떻게~? I'm really confused...
```

**문제:**
- 모델이 한국어로 시작했다가 영어로 전환
- "I'm really confused" → 모델 자신이 혼란스러워함
- 프롬프트가 너무 복잡해서 모델이 임무를 이해 못함

---

## 핵심 수정 사항

### V5 프롬프트 (Before) - 너무 복잡

```python
당신의 임무:
학생이 "{next_step_goal}"를 스스로 깨닫도록 유도하는 짧은 질문 1개를 만드세요.

절대 금지 사항 (매우 중요!):
1. 함수명, 변수명 언급 금지 (예: print_board, count_repaint 등)
2. 코드 구조 직접 언급 금지 (예: def, for, if 등)
3. 백틱(`)이나 코드 블록 사용 금지
4. "~해야 합니다", "~하세요" 같은 설명/지시 금지

소크라테스식 질문 원칙:
- 학생 코드의 한계점을 확장된 상황으로 제시
- "만약 ~라면?" 형식으로 문제 상황 가정
- 학생이 불편함을 느끼고 해결책을 생각하게 만들기
- 현재 코드가 감당하기 어려운 상황 제시
- 규모가 커지거나 반복/수정이 필요한 상황 강조

출력 형식:
- 한국어 반말로 완전한 질문 1개만
- 반드시 물음표(?)로 끝나야 함
- 불완전한 문장 금지 (예: "~하고,", "~하며," 같은 끝맺음)
- 코드나 구체적 이름 없이 순수 질문만

질문:
```

**문제점:**
- 너무 많은 원칙 나열 (9개 항목)
- "소크라테스식 질문 원칙" 같은 추상적 개념
- 모델이 지시사항을 놓치고 혼란스러워함

---

### V6 프롬프트 (After) - 초간단 직접 명령

```python
다음은 학생이 작성 중인 코드입니다:

{user_code}

학생이 다음에 해야 할 일: {next_step_goal}

당신의 임무: "{next_step_goal}"를 깨닫게 만드는 질문 1개를 한국어 반말로 작성하세요.

규칙:
1. 함수명/변수명 절대 언급 금지
2. 코드 문법(def, for, if 등) 언급 금지
3. 백틱이나 코드 사용 금지
4. 한국어만 사용 (영어 금지)
5. 반드시 물음표(?)로 끝나는 완전한 질문 작성

질문 작성 방법:
- "만약 이 작업을 [큰 규모]로 해야 한다면?" 형식
- 학생 코드의 한계를 확장된 상황으로 제시
- 학생이 불편함을 느끼고 해결책을 찾게 유도

출력: 한국어 반말 질문 1개 (물음표 필수)

질문:
```

**개선 사항:**
1. **간결함** - 불필요한 설명 제거
2. **직접적** - "작성하세요" 같은 명령형
3. **5개 규칙** - 핵심만 남김 (9개 → 5개)
4. **영어 금지 명시** - "한국어만 사용 (영어 금지)"
5. **출력 형식 단순화** - "질문 1개 (물음표 필수)"

---

## 영어 필터링 강화

### 문제: 한국어+영어 섞인 출력

```
그런데... 어떻게~? I'm really confused about...
```
→ 한국어 비율 30%로는 감지 못함

### 해결책: 3단계 영어 필터링 ([model_inference.py:174-192](../hint-system/models/model_inference.py#L174-L192))

**Before:**
```python
korean_chars = len(re.findall(r'[가-힣]', text_without_code))
total_chars = len(text_without_code.replace(' ', ''))

if total_chars > 0 and korean_chars / total_chars < 0.3:
    return "(모델이 한국어 힌트를 생성하지 못했습니다)"
```

**After:**
```python
# 1단계: 백틱/코드 블록 제거
text_without_code = re.sub(r'`[^`]+`', '', clean)
text_without_code = re.sub(r'```[^`]+```', '', text_without_code)

# 2단계: 영어 문장 감지 (대소문자 연속 5자 이상)
english_sentences = re.findall(r'[A-Za-z]{5,}', text_without_code)
if english_sentences:
    print(f"[DEBUG] 영어 문장 감지 필터링: {english_sentences[:3]}")
    return "(모델이 한국어 힌트를 생성하지 못했습니다)"

# 3단계: 한국어 비율 체크 (30% → 50%로 상향)
korean_chars = len(re.findall(r'[가-힣]', text_without_code))
total_chars = len(text_without_code.replace(' ', ''))

if total_chars > 0 and korean_chars / total_chars < 0.5:
    return "(모델이 한국어 힌트를 생성하지 못했습니다)"
```

**개선 사항:**
1. **영어 문장 감지** - "really", "confused", "about" 같은 5자 이상 영어 단어 즉시 차단
2. **한국어 비율 상향** - 30% → 50% (더 엄격)
3. **3단계 검증** - 백틱 제거 → 영어 감지 → 비율 체크

---

## 변경 위치

### 1. 프롬프트 간소화 ([app.py:322-346](../hint-system/app.py#L322-L346))

**파일:** `hint-system/app.py`
**함수:** `_create_analysis_prompt()`
**라인:** 322-346

### 2. 영어 필터 강화 ([model_inference.py:174-192](../hint-system/models/model_inference.py#L174-L192))

**파일:** `hint-system/models/model_inference.py`
**함수:** `_extract_hint_from_output()`
**라인:** 174-192

---

## 왜 V6가 필요했나?

### V5의 한계

1. **너무 복잡한 지시사항**
   - 9개 항목 + 추상적 개념
   - 모델이 핵심을 놓침

2. **모델 혼란**
   - "소크라테스식 질문 원칙" 같은 철학적 용어
   - 모델이 "I'm confused" 출력

3. **영어 필터 약함**
   - 한국어+영어 섞인 출력 감지 못함
   - 30% 기준으로는 부족

### V6의 개선

1. **초간단 명령**
   - 핵심 규칙 5개만
   - 직접적 명령형

2. **명확한 출력 형식**
   - "질문 1개 (물음표 필수)"
   - 모호함 제거

3. **3단계 영어 필터**
   - 영어 단어 즉시 감지
   - 한국어 비율 50% 요구

---

## V1 → V6 변천사

| 버전 | 주요 변경 | 남은 문제 |
|------|-----------|-----------|
| **V1** | 기본 프롬프트 | 함수명/변수명 언급 |
| **V2** | solution_code 제거 | 나쁜 예시 따라함 |
| **V3** | snake_case 필터 | 예시 의존 |
| **V4** | 소크라테스식, 예시 제공 | 예시 복사 |
| **V5** | 모든 예시 제거 | 프롬프트 복잡, 영어 섞임 |
| **V6** | 초간단 명령 + 영어 필터 강화 | ✅ 해결 예상 |

---

## 기대 효과

**Before (V5):**
```
그런데... 어떻게~? I'm really confused about...
(모델이 한국어 힌트를 생성하지 못했습니다)
```

**After (V6 예상):**
```
같은 검사를 여러 위치에서 반복해야 한다면 어떻게 할까?
이 작업을 나중에 다른 크기에도 쓰려면?
```

---

## 핵심 교훈

**프롬프트는 짧고 명확하게!**

- ❌ 추상적 개념: "소크라테스식 질문 원칙"
- ✅ 직접 명령: "한국어 반말 질문 1개 작성"

- ❌ 긴 설명: 9개 항목 나열
- ✅ 핵심 규칙: 5개 항목만

모델은 철학자가 아니라 **도구**다. 간단하고 직접적으로 지시하자!

---

**작성일:** 2025-01-30
**버전:** V6
**이전 버전:** [PROMPT_FIX_V5.md](PROMPT_FIX_V5.md)
추가 내용
