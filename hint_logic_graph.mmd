%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a90d9', 'primaryTextColor': '#000', 'primaryBorderColor': '#2d5986', 'lineColor': '#5c5c5c', 'secondaryColor': '#f0f0f0', 'tertiaryColor': '#fff'}}}%%

flowchart TD
    %% ==================== ë²”ë¡€ (ì¢Œì¸¡ ìƒë‹¨) ====================
    subgraph LEGEND1["ğŸ¯ Solution Matching í•µì‹¬ ì² í•™"]
        direction TB
        L1["âŒ ì‚¬ìš©ì ì½”ë“œë¥¼ 'í‹€ë ¸ë‹¤'ê³  í•˜ì§€ ì•ŠìŒ"]
        L2["âœ… ì‚¬ìš©ìì˜ í˜„ì¬ ë°©ì‹ ì¡´ì¤‘"]
        L3["âœ… 'ë‹¤ìŒ ë‹¨ê³„' ì•ˆë‚´ ë°©ì‹"]
        L4["âœ… solution_code ê¸°ë°˜ code_example"]
    end

    subgraph LEGEND2["ğŸ“‹ ë¶„ê¸° ì¡°ê±´"]
        direction TB
        B_A["A: ì½”ë“œ ì—†ìŒ/ë¬¸ë²• ì˜¤ë¥˜"]
        B_B["B: completion + í…ŒìŠ¤íŠ¸ ë¯¸í†µê³¼"]
        B_C["C: completion + ì²« í†µê³¼"]
        B_D["D: optimization + í…ŒìŠ¤íŠ¸ ë¯¸í†µê³¼"]
        B_E1["E1: ë³„ íšë“"]
        B_E2["E2: í’ˆì§ˆ ê°œì„  í•„ìš”"]
        B_F["F: ìµœì  ë‹¬ì„±"]
    end

    subgraph LEGEND3["ğŸ” Solution Matching ì•Œê³ ë¦¬ì¦˜"]
        direction TB
        SM1["ğŸ“Š ì½”ë“œ ìœ ì‚¬ë„ (60%)<br/>difflib.SequenceMatcher"]
        SM2["ğŸ“Š íŒ¨í„´ ìœ ì‚¬ë„ (40%)<br/>ì…ë ¥ë°©ì‹/ìë£Œêµ¬ì¡°/ì•Œê³ ë¦¬ì¦˜"]
        SM3["â†’ ê°€ì¥ ìœ ì‚¬í•œ ì†”ë£¨ì…˜ ì„ íƒ"]
    end

    %% ==================== ë©”ì¸ í”Œë¡œìš° ====================
    subgraph INPUT_STAGE["ğŸ”µ ì…ë ¥ ë‹¨ê³„"]
        START(["â–¶ START"])
        INPUT_NODE["ğŸ  input_node<br/>ì…ë ¥ ê²€ì¦ & ë¬¸ì œ ë¡œë“œ<br/>(title, description, solutions)"]
        START --> INPUT_NODE
    end

    subgraph MATCH_STAGE["ğŸ”µ ì†”ë£¨ì…˜ ë§¤ì¹­"]
        SOLUTION_MATCH["ğŸ” solution_match_node<br/>ì‚¬ìš©ì ì½”ë“œì™€<br/>ê°€ì¥ ìœ ì‚¬í•œ ì†”ë£¨ì…˜ ë§¤ì¹­"]
        INPUT_NODE --> SOLUTION_MATCH
    end

    subgraph PURPOSE_STAGE["ğŸ”µ ëª©ì  ê²°ì •"]
        PURPOSE_NODE["ğŸ¯ purpose_node<br/>ë³„ì  ì¡°íšŒ & ëª©ì  ê²°ì •<br/>(completion/optimization/optimal)"]
        SOLUTION_MATCH --> PURPOSE_NODE
    end

    subgraph PARALLEL_STAGE["ğŸŸ¢ ë³‘ë ¬ë¶„ì„ ë‹¨ê³„"]
        PARALLEL_NODE["âš¡ parallel_analysis_node<br/>(ThreadPoolExecutor)"]
        PURPOSE_NODE --> PARALLEL_NODE

        subgraph STATIC_BOX["ì •ì  ë¶„ì„"]
            STATIC["ğŸ“Š static_analysis<br/>ì •ì  ë©”íŠ¸ë¦­ 6ê°œ<br/>- syntax_errors<br/>- test_pass_rate<br/>- execution_time<br/>- memory_usage<br/>- code_quality_score<br/>- pep8_violations"]
        end

        subgraph LLM_BOX["LLM í‰ê°€"]
            LLM_EVAL["ğŸ¤– llm_eval<br/>LLM ë©”íŠ¸ë¦­ 6ê°œ<br/>- algorithm_efficiency<br/>- code_readability<br/>- edge_case_handling<br/>- code_conciseness<br/>- test_coverage_estimate<br/>- security_awareness"]
        end

        PARALLEL_NODE --> STATIC
        PARALLEL_NODE --> LLM_EVAL
        STATIC --> MERGE["ğŸ“¦ ê²°ê³¼ ë³‘í•©"]
        LLM_EVAL --> MERGE
    end

    subgraph BRANCH_STAGE["ğŸŸ  ë¶„ê¸° ê²°ì • ë‹¨ê³„"]
        BRANCH_NODE["ğŸ”€ branch_node<br/>ë¶„ê¸° ê²°ì • (A~F)"]
        MERGE --> BRANCH_NODE

        SKIP_CHECK{"â“ should_skip_coh<br/>A, C, E1 ë¶„ê¸°?"}
        BRANCH_NODE --> SKIP_CHECK
    end

    subgraph COH_STAGE["ğŸŸ¢ COH ê³„ì‚° ë‹¨ê³„"]
        COH_CHECK["ğŸ“Š coh_check_node<br/>COH ê¹Šì´ ê³„ì‚°<br/>(code_hash ë¹„êµ)"]
        COH_LEVEL["ğŸ“ˆ coh_level_node<br/>íŒíŠ¸ ë ˆë²¨ ê³„ì‚° (1-9)<br/>base_level - coh_depth"]
        COMPONENT_FILTER["ğŸ§© component_filter_node<br/>êµ¬ì„±ìš”ì†Œ í•„í„°ë§"]

        SKIP_CHECK -->|"continue<br/>B, D, E2, F"| COH_CHECK
        COH_CHECK --> COH_LEVEL
        COH_LEVEL --> COMPONENT_FILTER
    end

    subgraph LLM_STAGE["ğŸŸ¢ LLM íŒíŠ¸ ìƒì„±"]
        PROMPT_NODE["ğŸ“ prompt_node<br/>í”„ë¡¬í”„íŠ¸ êµ¬ì„±<br/>(COH ë ˆë²¨ + ë§¤ì¹­ëœ ì†”ë£¨ì…˜ ë°˜ì˜)"]
        PROMPT_RULE1["âœ… 'í‹€ë ¸ë‹¤' â†’ 'ë‹¤ìŒ ë‹¨ê³„' ì•ˆë‚´"]
        PROMPT_RULE2["âœ… í•™ìƒ ì½”ë“œ ìŠ¤íƒ€ì¼ ì¡´ì¤‘"]
        LLM_HINT["ğŸ¤– llm_hint_node<br/>GPT-4.1 íŒíŠ¸ ìƒì„±<br/>(solution_code ì°¸ê³ )"]
        FORMAT_NODE["âœ¨ format_node<br/>íŒíŠ¸ í¬ë§·íŒ…"]

        COMPONENT_FILTER --> PROMPT_NODE
        PROMPT_NODE --> PROMPT_RULE1
        PROMPT_RULE1 --> PROMPT_RULE2
        PROMPT_RULE2 --> LLM_HINT
        LLM_HINT --> FORMAT_NODE
    end

    subgraph SKIP_STAGE["ğŸŸ¡ COH & LLM ìŠ¤í‚µ ê²½ë¡œ"]
        SKIP_LLM["ğŸ’¬ skip_llm_node<br/>ì •ì  íŒíŠ¸ ë°˜í™˜<br/>(COH & LLM ìŠ¤í‚µ)"]
        SKIP_CHECK -->|"skip<br/>A, C, E1"| SKIP_LLM
    end

    subgraph SAVE_STAGE["ğŸŸ¢ ì €ì¥ ë‹¨ê³„"]
        SAVE_NODE["ğŸ’¾ save_node<br/>DB ì €ì¥<br/>(code_hash, hint_branch,<br/>coh_depth)"]
        END_NODE(["â–  END"])

        FORMAT_NODE --> SAVE_NODE
        SKIP_LLM --> SAVE_NODE
        SAVE_NODE --> END_NODE
    end

    %% ==================== ìŠ¤íƒ€ì¼ë§ ====================
    classDef startEnd fill:#4a90d9,stroke:#2d5986,color:white,stroke-width:2px
    classDef inputNode fill:#fff3cd,stroke:#ffc107,color:#000,stroke-width:2px
    classDef analysisNode fill:#d4edda,stroke:#28a745,color:#000,stroke-width:2px
    classDef branchNode fill:#ffe0b2,stroke:#ff9800,color:#000,stroke-width:2px
    classDef cohNode fill:#e8f5e9,stroke:#4caf50,color:#000,stroke-width:2px
    classDef llmNode fill:#fce4ec,stroke:#e91e63,color:#000,stroke-width:2px
    classDef skipNode fill:#fff9c4,stroke:#ffeb3b,color:#000,stroke-width:2px
    classDef saveNode fill:#e3f2fd,stroke:#2196f3,color:#000,stroke-width:2px
    classDef decisionNode fill:#fff3e0,stroke:#ff9800,color:#000,stroke-width:2px
    classDef legendBox fill:#f5f5f5,stroke:#9e9e9e,color:#000,stroke-width:1px

    class START,END_NODE startEnd
    class INPUT_NODE,SOLUTION_MATCH,PURPOSE_NODE inputNode
    class PARALLEL_NODE,STATIC,LLM_EVAL,MERGE analysisNode
    class BRANCH_NODE branchNode
    class SKIP_CHECK decisionNode
    class COH_CHECK,COH_LEVEL,COMPONENT_FILTER cohNode
    class PROMPT_NODE,PROMPT_RULE1,PROMPT_RULE2,LLM_HINT,FORMAT_NODE llmNode
    class SKIP_LLM skipNode
    class SAVE_NODE saveNode
    class L1,L2,L3,L4,B_A,B_B,B_C,B_D,B_E1,B_E2,B_F,SM1,SM2,SM3 legendBox
