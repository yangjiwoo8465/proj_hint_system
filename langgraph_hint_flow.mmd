%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a90d9', 'primaryTextColor': '#fff', 'primaryBorderColor': '#2d5986', 'lineColor': '#5c5c5c', 'secondaryColor': '#f0f0f0', 'tertiaryColor': '#fff'}}}%%

flowchart TD
    subgraph INIT["ğŸš€ ì´ˆê¸°í™”"]
        START([START]) --> INPUT[/"ğŸ“¥ input_node<br/>ì‚¬ìš©ì ì…ë ¥ ìˆ˜ì§‘<br/>(problem_id, user_code, preset, components)"/]
    end

    subgraph ANALYSIS["ğŸ” ë¶„ì„ ë‹¨ê³„"]
        INPUT --> SOLUTION["ğŸ” solution_match_node<br/>ì†”ë£¨ì…˜ ë§¤ì¹­<br/>(ìœ ì‚¬ë„ ê¸°ë°˜ ì •ë‹µ ì½”ë“œ ë§¤ì¹­)"]
        SOLUTION --> PURPOSE["ğŸ¯ purpose_node<br/>ëª©ì  ê²°ì •<br/>(completion/optimization/optimal)"]
        PURPOSE --> PARALLEL["âš¡ parallel_analysis_node<br/>ë³‘ë ¬ ë¶„ì„<br/>(ì •ì ë¶„ì„ + LLMí‰ê°€)"]
    end

    subgraph BRANCH["ğŸŒ¿ ë¶„ê¸° ê²°ì •"]
        PARALLEL --> BRANCH_NODE{"ğŸ”€ branch_decision_node<br/>ë¶„ê¸° ê²°ì • (A~F)"}

        BRANCH_NODE -->|"A: ì½”ë“œì—†ìŒ/ë¬¸ë²•ì˜¤ë¥˜"| SKIP_CHECK{should_skip_coh}
        BRANCH_NODE -->|"B: í…ŒìŠ¤íŠ¸ ë¯¸í†µê³¼"| SKIP_CHECK
        BRANCH_NODE -->|"C: ì²« í…ŒìŠ¤íŠ¸ í†µê³¼"| SKIP_CHECK
        BRANCH_NODE -->|"D: íš¨ìœ¨ì  ì™„ì„± í•„ìš”"| SKIP_CHECK
        BRANCH_NODE -->|"E1: ë³„ íšë“"| SKIP_CHECK
        BRANCH_NODE -->|"E2: í’ˆì§ˆ ê°œì„  í•„ìš”"| SKIP_CHECK
        BRANCH_NODE -->|"F: ìµœì  ë‹¬ì„±"| SKIP_CHECK
    end

    subgraph COH_SKIP["â­ï¸ ìŠ¤í‚µ ê²½ë¡œ (A, C, E1)"]
        SKIP_CHECK -->|"skip<br/>(A, C, E1)"| SKIP_LLM["ğŸ’¬ skip_llm_node<br/>ì •ì  ë©”ì‹œì§€ ë°˜í™˜<br/>(COH ê³„ì‚° ë¶ˆí•„ìš”)"]
    end

    subgraph COH_FLOW["ğŸ”„ COH ê²½ë¡œ (B, D, E2, F)"]
        SKIP_CHECK -->|"continue<br/>(B, D, E2, F)"| COH_CHECK["ğŸ“Š coh_check_node<br/>COH ê¹Šì´ ê³„ì‚°<br/>(ë™ì¼ ì½”ë“œ íŒíŠ¸ ìš”ì²­ íšŸìˆ˜)"]
        COH_CHECK --> COH_LEVEL["ğŸ“ˆ coh_level_node<br/>íŒíŠ¸ ë ˆë²¨ ê²°ì •<br/>(í”„ë¦¬ì…‹ + COH â†’ ë ˆë²¨ 1-9)"]
        COH_LEVEL --> COMPONENT["ğŸ§© component_filter_node<br/>êµ¬ì„±ìš”ì†Œ í•„í„°ë§<br/>(í”„ë¦¬ì…‹ë³„ ì œí•œ ì ìš©)"]
    end

    subgraph HINT_GEN["âœ¨ íŒíŠ¸ ìƒì„±"]
        COMPONENT --> PROMPT["ğŸ“ build_prompt_node<br/>í”„ë¡¬í”„íŠ¸ êµ¬ì„±<br/>(ë ˆë²¨ë³„ ìƒì„¸ë„ ì¡°ì ˆ)"]
        PROMPT --> LLM["ğŸ¤– generate_hint_node<br/>LLM íŒíŠ¸ ìƒì„±<br/>(GPT-4 í˜¸ì¶œ)"]
        LLM --> FORMAT["ğŸ¨ format_hint_node<br/>ìµœì¢… í¬ë§·íŒ…<br/>(êµ¬ì„±ìš”ì†Œ ì‚­ì œ ì—†ìŒ!)"]
    end

    subgraph OUTPUT["ğŸ’¾ ì¶œë ¥"]
        SKIP_LLM --> SAVE["ğŸ’¾ save_node<br/>íŒíŠ¸ ì €ì¥<br/>(HintRequest DB ì €ì¥)"]
        FORMAT --> SAVE
        SAVE --> END_NODE([END])
    end

    %% ìŠ¤íƒ€ì¼ë§
    classDef initNode fill:#4a90d9,stroke:#2d5986,color:white
    classDef analysisNode fill:#50c878,stroke:#3a9d5c,color:white
    classDef branchNode fill:#f5a623,stroke:#d4890c,color:white
    classDef skipNode fill:#9b9b9b,stroke:#7a7a7a,color:white
    classDef cohNode fill:#9013fe,stroke:#6b0fc0,color:white
    classDef hintNode fill:#e91e63,stroke:#c2185b,color:white
    classDef outputNode fill:#00bcd4,stroke:#0097a7,color:white
    classDef decisionNode fill:#ff9800,stroke:#f57c00,color:black

    class START,INPUT initNode
    class SOLUTION,PURPOSE,PARALLEL analysisNode
    class BRANCH_NODE,SKIP_CHECK decisionNode
    class SKIP_LLM skipNode
    class COH_CHECK,COH_LEVEL,COMPONENT cohNode
    class PROMPT,LLM,FORMAT hintNode
    class SAVE,END_NODE outputNode
